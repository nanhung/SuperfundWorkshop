---
title: "Workflow of pharmacokinetic modeling (model construction + data manipulation + visualization)"
author: "Nan-Hung Hsieh"
date: "2019/12/09 (update: `r Sys.Date()`)"
output: 
  html_document:
  fig_caption: yes  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd('..')
wd <- getwd()
knitr::opts_knit$set(root.dir =  wd)
```

## 0 Prerequisites

Import the R packages

```{R message=FALSE, warning=FALSE}
library(simuloR)
library(httk)
library(deSolve)
library(tidyverse)
theme_set(theme_bw())
```

## Task 1: Exploratory data analysis

- Now, we have a theophylline PK dataset. The purpose of this exercise is to develop the simple PK model and use it to describe the PK of theophylline. First, look into the theophylline dataset. The `Theoph` data frame has 132 rows and 5 columns of data from an experiment on the pharmacokinetics of theophylline. Then, find the Cmax and Tmax for each individual. 



```{r}
head(Theoph)
```


```{r}
tail(Theoph)
```


```{r}
subset(Theoph, Subject == 1)
```


```{r}
subset(Theoph, Subject == 1) %>% summary()
```


```{r}
s1 <- subset(Theoph, Subject == 1) 
plot(s1$Time, s1$conc)
```


```{r}
plot(Theoph$Time, Theoph$conc, col=Theoph$Subject)
```


```{r}
par(mfrow=c(3,4))
for(i in 1:12){
  dat <- subset(Theoph, Subject == i)  
  plot(dat$Time, dat$conc, main = i)
}
```

```{r}
Theoph %>% ggplot(aes(x = Time, y =conc, color = Subject)) + 
  geom_point()
```

```{r}
Theoph %>% ggplot(aes(x = Time, y =conc, color = Subject)) + 
  geom_point() + geom_line() + 
  labs(x = "Time (hr)", y = "Concentration (mg/L)")
```

```{r}
Theoph %>% ggplot(aes(x = Time, y =conc)) + 
  geom_point() + geom_line() + 
  facet_wrap(~Subject) + 
  labs(x = "Time (hr)", y = "Concentration (mg/L)")
```


```{r}
class(Theoph$Subject)
```

```{r}
Theoph$Subject
```

```{r}
Theoph$Subject <- factor(Theoph$Subject, 
                            level = c("1", "2", "3", "4", "5", "6", 
                                      "7", "8", "9", "10", "11","12"))
```


```{r}
Theoph$Subject
```


```{r}
Theoph %>% ggplot(aes(x = Time, y =conc)) + 
  geom_point() + geom_line() + 
  facet_wrap(~Subject) + 
  labs(x = "Time (hr)", y = "Concentration (mg/L)")
```


```{r}
s1.Cmax <- max(s1$conc)
s1.Cmax
```


```{r}
which(s1$conc == s1.Cmax)
```


```{r}
t.pt <- which(s1$conc == s1.Cmax)
T_max <- s1$Time[t.pt]
```





```{r}
Cmax_pop <- Theoph %>% group_by(Subject) %>% summarise(C_max = max(conc))
Cmax_pop
```


```{r}
hist(Cmax_pop$C_max)
```


```{r}
boxplot(Cmax_pop$C_max)
```


```{r}
Theoph %>% group_by(Subject) %>% summarise(C_max = max(conc), Wt=mean(Wt))
```

```{r}
Theoph %>% group_by(Subject) %>% 
  summarise(C_max = max(conc), Wt=mean(Wt)) %>% 
  ggplot(aes(x=Wt, y=C_max)) + geom_point()
```


```{r}
Theoph %>% group_by(Subject) %>% 
  summarise(C_max = max(conc), Wt=mean(Wt)) %>% 
  ggplot(aes(x=Wt, y=C_max)) + geom_point() + geom_smooth(method = "lm")
```


```{r}
df <- Theoph %>% group_by(Subject) %>% summarize(C_max = max(conc))
df$T_max <- NA
df
```


```{r}
dat <- subset(Theoph, Subject==1)
C_max.pt <- which(dat$conc == df$C_max[1])
df$T_max[1] <- dat$Time[C_max.pt]
df
```


```{r}
for(i in 2:12){
  dat <- subset(Theoph, Subject==i)
  C_max.pt <- which(dat$conc == df$C_max[i])
  df$T_max[i] <- dat$Time[C_max.pt]
}
df
```


## Task 2: Model development

- Develop the non compartment model and compartment model in R and MCSim


- Non compartment model

$$C(t) = \frac{F\cdot D \cdot ka}{V(k_a - k_e)}\cdot(\mathrm{e}^{-k_et}-\mathrm{e}^{-k_a{t}})$$

- Compartment model

$$\frac{dA_{gut}}{dt}=-k_aA_{gut}$$

$$\frac{dA}{dt}=k_aA_{gut}-k_eA_e$$
$$C=A/V$$


- Non compartment model (R)

```{r}
ffpk <- function(D, Fa, ka, ke, V, t){
    MW <- 180.167
    A <- (D * Fa * ka)/(V * (ka - ke))
    C <- A * exp(-ke * t) - A * exp(-ka * t)
    C_uM <- C/MW*1000
    return(C_uM)
}
```

- Non compartment model (MCSim)

```r
Outputs = {
  A,
  Conc,
  Ccompartment
}

## ingested input (mg)
IngDose = 1.0; 
## Molecular weight (g/mole)
MW = 100;
## Absorption fraction (-)
Fgutabs = 1.0; #
## Absorption rate constant (/h)
kgutabs = 1.0; #
## Elimination rate constants (/h)
kelim = 1.0;
## Distribution volumes (L)
Vdist = 1.0;

CalcOutputs { 
  A = (IngDose * Fgutabs * kgutabs)/(Vdist * (kgutabs - kelim));
  Conc = A * exp(-kelim * t) - A * exp(-kgutabs * t);
  Ccompartment = Conc / MW * 1000;
}

End.
```

- Compartment model (R)

```r
pbtk1cpt <- function(t, state, parameters) {
  with(as.list(c(state, parameters)), {
    
    dAgutlument = - kgutabs * Agutlument
    dAcompartment = kgutabs * Agutlument - ke * Acompartment
    dAmetabolized = ke * Acompartment
    
    Ccompartment = Acompartment / vdist * BW;
    
    list(c(dAgutlument, dAcompartment, dAmetabolized), 
         "Ccompartment" = Ccompartment) 
  })
}
```

- Compartment model (MCSim)

```
States  = { 
  A_rest, 
  A_elim
};  # Quantity in central compartment (mg)

Inputs = { 
  Oral_input
}; # Drug input (mg)

Outputs = { 
  Ccompartment
};  # Concentration in central compartment (uM)

# Oral input modeling
Absdose;
IngDose    = 1.0; # ingested input (mg)
Fgutabs    = 1.0; #
Period     = 0.0; # period of the exposure/no exposure cycle (h)
Tlag       = 0.0; # Absorption lagtime (h)
kgutabs    = 0.1; # Intestinal absortion rate (/h)
Oral_input = PerExp (Absdose, Period, Tlag, kgutabs);

# Molecular weight (g/mole)
MW = 100;
# Distribution volumes (L)
Vdist  = 1;
# Elimination rate constants (/h)
kelim = 1;

Initialize{ Absdose = IngDose * Fgutabs; }

Dynamics { 
  dt (A_rest) = kgutabs * Oral_input - kelim * A_rest;
  dt (A_elim) = kelim * A_rest;
}

CalcOutputs { 
  Ccompartment  = A_rest  / Vdist / MW * 1000; 
}

End.
```

## Task 3: Parameter setting and simulation

- Extract the chemical information from httk package

```{r}
library(httk)
parms <- httk::parameterize_1comp(chem.name = "theophylline")
parms
```

- Use the parameters in the developed model and conduct the simulation 
- Compare the difference between data and the model simulation result (Cmax, Tmax)

R

```{r}
MW <- parms$MW
Fgutabs <- parms$Fgutabs * parms$hepatic.bioavailability
kgutabs <- parms$kgutabs
kelim <- parms$kelim
Vdist <- parms$Vdist
```


```{r}
dose1 <- subset(Theoph, Subject == 1) %>% summarise(dose = mean(Dose))
t1 <- subset(Theoph, Subject == 1) %>% select(Time)
out1 <- ffpk(D = dose1$dose, Fa = Fgutabs, ka = kgutabs, ke = kelim, V = Vdist, t=t1$Time)
out1
```


```{r}
conc1 <- subset(Theoph, Subject == 1) %>% select(conc)
plot(t1$Time, out1, type = "l")
points(t1$Time, conc1$conc)
```



```{r}
data.frame(t1, out1)
```


MCSim


```
Integrate (Lsodes, 1e-8, 1e-8, 1);

MW         = 180.167;  # moleculor mass (g/mol)
IngDose    = 4.02;     # ingested dose (mg)
Period     = 48;       # period of the exposure/no exposure cycle (h)
Fgutabs    = 0.9142;   # bioavailability (-) 
kgutabs    = 2.18;     # absortion rate (/h)
kelim      = 0.2654;   # elimination rate constant (/h)
Vdist      = 0.7802;   # volumes (L)

Simulation {
  Print (Ccompartment 0.00   0.25   0.57   1.12   2.02   3.82   5.10   7.03   9.05  12.12  24.37);
}
End.
```

```{r}
mcsim(model = "models/pbtk1cpt.model", input = "inputs/pbtk1cpt.in")
```


```{r}
read.delim("sim.out")
```

```{r}
read.delim("sim.out", skip = 1)
```


```{r}
out <- mcsim(model = "models/pbtk1cpt.model", input = "inputs/pbtk1cpt.in")
out
```

```{r}
plot(out$Time, out$Ccompartment, type = "l")
points(t1$Time, conc1$conc)
```

## Task 4: Developing the PBPK model

- Instead of simple PK model, in this exercise we want to apply the well developed PBPK model for 1,3 butadiene.

- First, reproduce the simulation result from the published paper*.

Inputs

```{r}
C_inh <- approxfun(x = c(0, 120), y=c(10,0), method = "constant", f = 0, rule = 2) 
```

```{r}
plot(C_inh(1:300), type="l", xlab = "Time (min)", ylab = "Butadiene inhaled concentration (ppm)")
```

Parameters and outputs 

```{r}
parameters <- c("BDM" = 73,            # Body mass (kg)
                "Height" = 1.6,        # Body height (m)
                "Age" = 40,            # in years
                "Sex" = 1,             # code 1 is male, 2 is female
                "Flow_pul" = 5,        # Pulmonary ventilation rate (L/min)
                "Pct_Deadspace" = 0.7, # Fraction of pulmonary deadspace
                "Vent_Perf" = 1.14,    # Ventilation over perfusion ratio
                "Pct_LBDM_wp" = 0.2,   # wp tissue as fraction of lean mass
                "Pct_Flow_fat" = 0.1,  # Fraction of cardiac output to fat
                "Pct_Flow_pp" = 0.35,  # ~ to pp
                "PC_art" = 2,          # Blood/air partition coefficient
                "PC_fat" = 22,         # Fat/blood ~
                "PC_wp" = 0.8,         # wp/blood ~
                "PC_pp" = 0.8,         # pp/blood ~
                "Kmetwp" = 0.25)       # Rate constant for metabolism
```

```{r}
y <- c("Q_fat" = 0, # Quantity of butadiene in fat (mg)
       "Q_wp" = 0,  # ~ in well-perfused (mg)
       "Q_pp" = 0,  # ~ in poorly-perfused (mg)
       "Q_met" = 0) # ~ metabolized (mg)
```



```{r}
# Define the model equations
bd.model = function(t, y, parameters) {
  with (as.list(y), {
    with (as.list(parameters), {
      
      # Define some known constants
      Height = 1.6       # use to calculate fraction of body fat
      Age = 40           # use to calculate fraction of body fat
      Sex = 1            # use to calculate fraction of body fat
      MW_bu = 54.0914    # butadiene molecular weight (in grams)

      # Conversions from/to ppm
      ppm_per_mM = 24450 # ppm to mM under normal conditions
      ppm_per_mg_per_l = ppm_per_mM / MW_bu
      mg_per_l_per_ppm = 1 / ppm_per_mg_per_l
      
      # Calculate Flow_alv from total pulmonary flow
      Flow_alv = Flow_pul * (1 - Pct_Deadspace)
      
      # Calculate total blood flow from Flow_alv and the V/P ratio
      Flow_tot = Flow_alv / Vent_Perf
      
      # Calculate fraction of body fat
      Pct_BDM_fat = (1.2 * BDM / (Height * Height) - 10.8
                     *(2 - Sex) + 0.23 * Age - 5.4) * 0.01
      
      # Actual volumes, 10% of body mass (bonesâ€¦) get no butadiene
      Eff_V_fat = Pct_BDM_fat * BDM
      Eff_V_wp = Pct_LBDM_wp * BDM * (1 - Pct_BDM_fat)
      Eff_V_pp = 0.9 * BDM - Eff_V_fat - Eff_V_wp
      
      # Calculate actual blood flows from total flow and percent flows
      Flow_fat = Pct_Flow_fat * Flow_tot
      Flow_pp = Pct_Flow_pp * Flow_tot
      Flow_wp = Flow_tot * (1 - Pct_Flow_pp - Pct_Flow_fat)
      
      # Calculate the concentrations
      C_fat = Q_fat / Eff_V_fat
      C_wp = Q_wp / Eff_V_wp
      C_pp = Q_pp / Eff_V_pp
      
      # Venous blood concentrations at the organ exit
      Cout_fat = C_fat / PC_fat
      Cout_wp = C_wp / PC_wp
      Cout_pp = C_pp / PC_pp
      
      # Sum of Flow * Concentration for all compartments
      dQ_ven = Flow_fat * Cout_fat + Flow_wp * Cout_wp + Flow_pp * Cout_pp
      C_inh.current = C_inh(t) # to avoid calling C_inh() twice
      
      # Arterial blood concentration
      # Convert input given in ppm to mg/l to match other units
        C_art = (Flow_alv * C_inh.current * mg_per_l_per_ppm + dQ_ven) / (Flow_tot + Flow_alv / PC_art)
      
      # Venous blood concentration (mg/L)
      C_ven = dQ_ven / Flow_tot
      
      # Alveolar air concentration (mg/L)
      C_alv = C_art / PC_art
      
      # Exhaled air concentration (ppm)
      if (C_alv <= 0) {
        C_exh = 10E-30 # avoid round off errors
      } else {
        C_exh = (1 - Pct_Deadspace) * C_alv * ppm_per_mg_per_l + Pct_Deadspace * C_inh.current
      }
      
      # Quantity metabolized in liver (included in well-perfused)
      dQmet_wp = Kmetwp * Q_wp
      
      # Differentials for quantities
      dQ_fat = Flow_fat * (C_art - Cout_fat)
      dQ_wp = Flow_wp * (C_art - Cout_wp) - dQmet_wp
      dQ_pp = Flow_pp * (C_art - Cout_pp)
      dQ_met = dQmet_wp

      # The function bd.model must return at least the derivatives
      list(c(dQ_fat, dQ_wp, dQ_pp, dQ_met), # derivatives
           c("C_ven" = C_ven, "C_art" = C_art)) # extra outputs

    }) # end with parameters
  }) # end with y
} # end bd.model

```


```{r}
# Define the computation output times
t <- seq(from=0, to=1440, by=10)

# Solve ODE
out <- ode(times=t, func=bd.model, y=y, parms=parameters)
head(out)
```


```{r}
plot(out)
```


## Task 5: Apply the PBPK model

- Based on the OSHA permissible exposure limit (PEL), the time-weighted average is 1 ppm. If a worker is under the exposure for a long time, what is the estimated blood concentration.

```{r}
t_exposure <- 43200 # 30 days
C_inh <- approxfun(x = c(0, t_exposure), y=c(10,0), method = "constant", f = 0, rule = 2) 
```

```{r}
plot(C_inh(1:t_exposure), type="l", xlab = "Time (min)", ylab = "Butadiene inhaled concentration (ppm)")
```


```{r}
t <- seq(from=0, to=t_exposure, by=100)
out <- ode(times=t, func=bd.model, y=y, parms=parameters)
```


```{r}
tail(out, 10)
```


```{r}
plot(out)
```

## Session info

```{r}
sessionInfo()
```

## Reference

Bois F.Y. 2013. [Bayesian Inference](https://link.springer.com/protocol/10.1007/978-1-62703-059-5_25#Bib1). In: Reisfeld B., Mayeno A. (eds) Computational Toxicology. Methods in Molecular Biology (Methods and Protocols), vol 930. Humana Press, Totowa, NJ

Bois F.Y., Brochot C. (2016) [Modeling Pharmacokinetics](https://link.springer.com/protocol/10.1007%2F978-1-4939-3609-0_3). In: Benfenati E. (eds) In Silico Methods for Predicting Drug Toxicity. Methods in Molecular Biology, vol 1425. Humana Press, New York, NY

Pearce, R.G., Setzer, R.W., Strope, C.L., Wambaugh, J.F. and Sipes, N.S., 2017. [httk: R package for high-throughput toxicokinetics](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6134854/). Journal of statistical software, 79(4), p.1.

Soetaert, K.E., Petzoldt, T. and Setzer, R.W., 2010. [Solving differential equations in R: package deSolve](https://www.jstatsoft.org/article/view/v033i09). Journal of statistical software, 33.
