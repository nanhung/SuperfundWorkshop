---
title: "Workflow of pharmacokinetic modeling (model construction + data manipulation + visualization)"
author: "Nan-Hung Hsieh"
date: "2019/12/09 (update: `r Sys.Date()`)"
output: 
  html_document:
  fig_caption: yes  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd('..')
wd <- getwd()
knitr::opts_knit$set(root.dir =  wd)
```

# 0 Prerequisites

Import the R packages

```{R message=FALSE, warning=FALSE}
library(simuloR)
library(httk)
library(tidyverse)
```

# 1 One-compartment model 

## 1.1 Analyze *GNU MCSim* output with *R*

*GNU MCSim* doesn't include a comprehensive tool to analyze and visualize the simulation result. The best way to do further data analysis and visualization is to use *R*. This instruction will provide some basic R functions that can use to learn and understand how to analyze *GNU MCSim* output with *R*. 

First, run 

```{r}
mcsim(model = "models/pbtk1cpt.model", input = "inputs/pbtk1cpt.in")
```


### 1.1.1 Loading output

The simulation output is written under tab-delimited text file with default name `sim.out`. It is located in the directory. You can check your file through files tab on the bottom-right panel in RStudio. Or use `file.exists()` to check the file as,

```{r}
file.exists("sim.out")
```

If you can find your output file in your working directory, then you can us R function `read.delim()` to read it. Since the first line of the output file is used to describe the number of simulation, it can't be used in the formal data structure. Therefore, we need to assign `skip = 1` to ignore this line. Then run the following code and check your result:

```{r}
read.delim(file = "sim.out", skip = 1)
```

Through this function, we can only read the content in the output file, but we can’t use the data unless we assign it to a variable. Therefore, we need to assign a variable for the output to help us analyze it. The assigned variables will be temporarily stored in memory. 

### 1.1.2 Assign variables

Use the assignment operator `<-` to create new variables.

```{r}
out <- read.delim(file = "sim.out", skip = 1)
```

Once a variable is created, we can use the variable name to refer to the simulation data it was assigned. To view the variable in RStudio, you can interact with it in the top-right panel. Or, use `View()` to check it:

```{r, eval=F}
View(out)
```

### 1.1.3 Manipulating output

Now, our data is loaded into R. We can start doing further analysis with them. First, let’s check what type it is:

```{r}
class(out)
```

The output tells us that it’s a "data frame". This type of data structure constructed by the specific number of column (variable) and row (observation). We can see the dimensions of the data frame with the function `dim()`: 
```{r}
dim(out)
```

Or use `nrow()` and `ncol()` to check the information:

```{r}
nrow(out)
ncol(out)
```

Also, the `names()` can be used to get and set the names of variables

```{r}
names(out)
```

Some basic functions can be used to summarize the result, such as `mean()`, `min()`, `max()`. Here is an example to find the maximum concentration in blood:  

```{r}
max(out$Ccompartment)
```

Here, the `$` is used to assign the specific variable that was stored in the object. Also, you can quickly check all maximum or minimum concentration through `apply`:

```{r}
apply(out, MARGIN = 2, FUN = max)
```

You can also use `which()` to find the value as:

```{r}
which(out$Ccompartment == max(out$Ccompartment))
```

But, the `which()` only give us the location, not time point. Therefore, we need to use this location to find the corresponding time point by:

```{r}
which_row <- which(out$Ccompartment == max(out$Ccompartment))
out$Time[which_row]
```

The following code can let you set the variable name:

```{r}
names(out) <- c("Time", "A_input", "A_rest", "A_elim", "Ccompartment")
```

Check again,

```{r}
names(out)
```

If you only want to change the specific variable, you can use:

```{r}
names(out)[5] <- "C_rest"
names(out)
```

The unit conversion is the cruical part in data manipulation as well. Here we want to transfer the unit from mg/l to mol/l,

```{r}
out$A_total <- out$A_input + out$A_rest + out$A_elim
out
```

Finally, if you prefer to use Excel, you can use `write.csv()` to transfer your object to Comma-separated values (csv) file, then you can use Excel to open it and do additional analysis.

```{r, eval=F}
write.csv(out, file = "sim.csv", row.names = F)
```

### 1.1.4 Plotting

Visualizing the output data is an important work to communicate the simulation result. After the data manipulation, we can use `plot()` to create the PK diagram as:


```{r}
plot(x = out$Time, y = out$C_rest)
```

Usually, the basic assignment cannot provide high quality and comprehensive figure that can further use in our report or published paper. Therefore, we need to use additional assignments such as `xlab`, `ylab`, `main` to add the description or modification.

```{r}
plot(x = out$Time, y= out$C_rest, 
     type = "l", col = "red", xlab = "Time post intake (h)", ylab = "Blood concentration (uM)", 
     main = "BPA PK modeling")
legend("topright", legend = "Prediction", col="red", lty=1)
```

Here is an example to plot the multi simulation results in the same plot.

```{r}
plot(x = out$Time, y= out$A_input, type = "l", col = "red", 
     xlab = "Time post intake (hr)", ylab = "Dose (mg)",
     main = "BPA 1-cpt PK modeling", ylim = c(0,1))
lines(x = out$Time, y= out$A_rest, col = "blue")
lines(x = out$Time, y= out$A_elim, col = "green")
lines(x = out$Time, y= out$A_total, lty = "dashed")
legend("topright", legend = c("A_input", "A_rest", "A_elim"), col=c("red","blue", "green"),
       lty=1)
```

In addition, the relationship of concentration in blood and air can further be visualized through this way,

```{r}
plot(x = out$A_rest, y= out$A_elim, 
     type = "n", xlab = "A_rest" , ylab = "A_elim", 
     main = "Phase plane (Unit of time: hr)")
text(out$A_rest, y= out$A_elim, label = round(out$Time, 1), col="blue")
lines(x = out$A_rest, y= out$A_elim, lty = "dotted")
```

Finally, we can use `pdf()` to export the plotting result to portable document format (pdf) as:

```{r, eval=F}
pdf("perc_pk.pdf")
plot(x = out$Time, y= out$A_input, type = "l", col = "red", 
     xlab = "Time post intake (hr)", ylab = "Dose (mg)",
     main = "BPA 1-cpt PK modeling", ylim = c(0,1))
lines(x = out$Time, y= out$A_rest, col = "blue")
lines(x = out$Time, y= out$A_elim, col = "green")
lines(x = out$Time, y= out$A_total, lty = "dashed")
legend("topright", legend = c("A_input", "A_rest", "A_elim"), col=c("red","blue", "green"),
       lty=1)
dev.off()
```


## 1.2 Application with httk package 

In this section, we'll use 1-compartment model in **httk** package as the example to conduct the analysis. 

### 1.2.1

The `parameterize_1comp()` provide the baseline value of parameters that needed in the 1-compartment model. The selected chemical in this case study is Bisphenol A.

```{r}
#get_cheminfo(info = "compound")
params <- parameterize_1comp(chem.name='Bisphenol A', species='Human')
unlist(params)
```

Select the parameters of molecular weight (`MW`), absorption fraction (`Fgutabs`), distribution volume (`Vdist`), absorption rate (`kgutabs`), and elimination rate (`kelim`) that will be used in uncertainty and sensitivity analysis.

```{r}
MW <- params$MW
Fgutabs <- params$Fgutabs * params$hepatic.bioavailability
kgutabs <- params$kgutabs
Vdist <- params$Vdist
kelim <- params$kelim
```

### 1.2.2 Forward simulation 

Use `solve1comp` to simulate the time-dependent concentration of BPA. The given daily dose is 1 mg/kg.

```{r warning=FALSE, eval=T}
t <- seq(0, 2 ,0.01)
out_httk <- solve_1comp(parameters=params, doses.per.day = 1, daily.dose = 1, times = t)
```


```{r}
plot(out_httk) # output.units = "uM"
```


Plot result

```{r}
data <- as.data.frame(out_httk)
plot(data$time * 24, data$Ccompartment, type = "l", main = "BPA",
     xlab = "Time (hr)", ylab = "Concentration (uM)")
lines(out$Time, out$C_rest, col = "red")
```


```{r}
t <- seq(0, 10 ,0.01)
out_httk <- solve_1comp(parameters=params, doses.per.day = 1, daily.dose = 1, times = t)
data <- as.data.frame(out_httk)
```

```{r}
# Estimate css
dose <- 1 / 1000 * MW # mg -> uM
httk_css <- calc_analytic_css(chem.name = "Bisphenol A", model = "1compartment")

# Plot result
plot(data$time, data$Ccompartment, type = "l", main = "BPA (pbtk1cpt)",
     xlab = "Time (day)", ylab = "Concentration (uM)")
abline(h = httk_css)
```



Syntax of the model description file


```r
# Model description file (this is a comment)

<Global variable specifications>

States = { 
  <state variables for the model, such as quantity> 
}
Outputs = { 
  <output variables, such as concentration> 
}
Inputs = { 
  <input variables, such as exposure dose>
}
Initialize {
  <Equations for initializing or scaling model parameters>
}
Dynamics {
  <Equations for computing derivatives of the state variables>
}
CalcOutputs {
  <Equations for computing output variables>
}
End. # mandatory ending keyword
```
]


General syntax 

Variable assignments 

```r
<variable-name> = <constant-value-or-expression> ;
```

Colon conditional assignments 

```r
<variable-name> = (<test> ? <value-if-true> : <value-if-false>);
```

For example

```r
Adjusted_param = (Input_var > 0.0 ? Param * 1.1 : Param);
```


Syntax of (simulation) input-file

For the basic simulation 

```r
# Input-file (text after # are comments)
<Global assignments and specifications>
Simulation {
  <Specifications for first simulation>
}
Simulation {
  <Specifications for second simulation>
}
# Unlimited number of simulation specifications
End. # Mandatory End keyword. Everything after this line is ignored
```



Syntax of (simulation) input-file

For MCMC simulation

```r
# Input-file
<Global assignments and specifications>
Level {
  # Up to 10 levels of hierarchy
  Simulation {
    <Specifications and data for first simulation>
  }
  Simulation {
    <Specifications and data for second simulation>
  }
  # Unlimited number of simulation specifications
} # end Level
End. # Mandatory keyword.
```



Distribution functions

- **Normal** takes two reals numbers as parameters: the mean and the standard deviation, the latter being strictly positive.

- **LogNormal**, takes two reals numbers as parameters: the geometric mean (exponential of the mean in log-space) and the geometric standard deviation (exponential, strictly superior to 1, of the standard deviation in log-space).

- **Uniform**, with two shape parameters: the minimum and the maximum of the sampling range (real numbers).

- **LogUniform** with two shape parameters: the minimum and the maximum of the sampling range (real numbers) in natural space.

- **TruncNormal** (truncated normal distribution), takes four real parameters: the mean, the standard deviation (strictly positive), the minimum and the maximum.
mean, and its standard deviation.

- **InvGamma** (inverse gamma distribution), needs two strictly positive real parameters: the shape and the scale.



Input functions

These functions can use to different exposure types

```r
- PerDose(): # specifies a periodic input of constant

    PerDose(<magnitude>, <period>, <initial-time>, <exposure-time>);

  
- PerExp(): # specifies a periodic exponential input.

    PerExp(<magnitude>, <period>, <initial-time>, <decay-constant>);  

  
- PerTransit(): models a delayed input mechanism  

    PerTransit(<magnitude>, <period>, <initial-time-in-period>, 
              <decay-constant>, <number-of-input-compartments>);  
    
              
- NDoses(): specifies a number of stepwise inputs of variable magnitude and their starting times
    
    NDoses(<n>, <list-of-magnitudes>, <list-of-initial-times>);


- Spikes(): specifies a number of instantaneous inputs of variable magnitude and their exact times of occurrence.
    
    Spikes(<n>, <list-of-magnitudes>, <list-of-times>);

```

















## Exercise 2.1

Construct the butadiene-PBPK model code for MCSim based ob the R model code

## Exercise 2.2

Run butadiene-PBPK model under 10 ppm exposure for 100 minutes and plot the time-course of exhaled air concentration from 0 to 1400 minutes.

```{r}
out <- mcsim(model = "models/butadiene.model", input = "inputs/bd1.in")
```


```{r}
par(mfrow=c(2,3))
plot(out$Time, out$Q_fat, type="l")
plot(out$Time, out$Q_wp, type="l")
plot(out$Time, out$Q_pp, type="l")
plot(out$Time, out$Q_met, type="l")
plot(out$Time, out$C_ven, type="l")
plot(out$Time, out$C_art, type="l")
```

## Exercise 2.3

Estimate the steady-state of exhaled air concentrations associated with butadiene exposures (from 0.1 ppm to 1000 ppm).


```{r}
out <- mcsim(model = "models/butadiene.model", input = "inputs/bd2.in")
tail(out)
```

```{r}
str.sim <- which(out[,1] == 0)
end.sim <- which(out[,1] == 144000)
str.sim
end.sim
```


```{r}
sim.1 <- str.sim[1]:end.sim[1]
t1 <- out[sim.1,1] %>% as.character() %>% as.numeric()
c1 <- out[sim.1,2] %>% as.character() %>% as.numeric()
plot(t1, c1)
```


```{r}
par(mfrow=c(2,2))
for (i in 1:4){
sim <- str.sim[i]:end.sim[i]
t1 <- out[sim,1] %>% as.character() %>% as.numeric()
c1 <- out[sim,2] %>% as.character() %>% as.numeric()
plot(t1, c1, type="l")  
}
```


# Session info

```{r}
sessionInfo()
```

# Reference

Bois F.Y. 2013. [Bayesian Inference](https://link.springer.com/protocol/10.1007/978-1-62703-059-5_25#Bib1). In: Reisfeld B., Mayeno A. (eds) Computational Toxicology. Methods in Molecular Biology (Methods and Protocols), vol 930. Humana Press, Totowa, NJ

Bois F.Y., Brochot C. (2016) [Modeling Pharmacokinetics](https://link.springer.com/protocol/10.1007%2F978-1-4939-3609-0_3). In: Benfenati E. (eds) In Silico Methods for Predicting Drug Toxicity. Methods in Molecular Biology, vol 1425. Humana Press, New York, NY

Pearce, R.G., Setzer, R.W., Strope, C.L., Wambaugh, J.F. and Sipes, N.S., 2017. [httk: R package for high-throughput toxicokinetics](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6134854/). Journal of statistical software, 79(4), p.1.

Smith, T.J., Bois, F.Y., Lin, Y.S., Brochot, C., Micallef, S., Kim, D. and Kelsey, K.T., 2008. [Quantifying heterogeneity in exposure–risk relationships using exhaled breath biomarkers for 1, 3-butadiene exposures.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4394655/) Journal of breath research, 2(3), p.037018.
